WITH LatestScanRuns AS (
    SELECT 
        scan_id,
        MAX(scan_start) as latest_scan_start
    FROM 
        scan_run
    GROUP BY 
        scan_id
)
SELECT 
    s.name AS scan_name,
    sr.scan_run_id,
    FROM_UNIXTIME(sr.scan_start) AS scan_start_time,
    FROM_UNIXTIME(sr.scan_end) AS scan_end_time,
    sr.host_count,
    sr.critical_count,
    sr.high_count,
    sr.medium_count,
    sr.low_count,
    sr.info_count,
    h.host_ip,
    h.host_fqdn,
    h.os
FROM 
    scan s
JOIN 
    LatestScanRuns lsr ON s.scan_id = lsr.scan_id
JOIN 
    scan_run sr ON lsr.scan_id = sr.scan_id AND lsr.latest_scan_start = sr.scan_start
LEFT JOIN 
    host h ON sr.scan_run_id = h.scan_run_id
ORDER BY 
    s.name, h.host_ip;
